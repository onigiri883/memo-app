<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ちょいメモ Web</title>
<style>
  :root {
    --bg: #f6f7f8;
    --panel: #ffffff;
    --accent: #2f80ed;
    --muted: #a0a4ab;
    --danger: #d9534f;
    --tab-height: 32px;
  }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: #222;
    font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif;
  }
  .app {
    max-width: 720px;
    margin: 40px auto;
    background: var(--panel);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid #eceff3;
  }
  .header .title {
    font-size: 16px;
    font-weight: 600;
  }
  .tabs {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 8px 0;
    overflow-x: auto;
    scrollbar-width: thin;
  }
  .tab {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    height: var(--tab-height);
    padding: 0 10px;
    border-radius: 8px;
    background: transparent;
    color: #555;
    user-select: none;
    white-space: nowrap;
    border: 1px solid transparent;
  }
  .tab.active {
    background: rgba(47,128,237,.12);
    color: #111;
    border-color: rgba(47,128,237,.25);
  }
  .tab:hover {
    background: #f2f4f7;
  }
  .tab .label {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .tab input.title-edit {
    height: 22px;
    font-size: 13px;
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid #d9dde3;
    outline: none;
    width: 160px;
  }
  .icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    margin-left: auto;
    padding: 8px;
    font-size: 16px;
  }
  .icon-btn:hover { background: #eef1f5; color: #444; }
  .icon-btn.danger:hover { color: var(--danger); background: #fdeeee; }

  .tabs-footer {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px 8px;
    border-bottom: 1px solid #eceff3;
  }

  .editor-wrap {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .editor {
    min-height: 280px;
    width: 100%;
    box-sizing: border-box;
    resize: none;
    overflow: hidden;
    border-radius: 10px;
    border: 1px solid #e1e5ea;
    padding: 12px;
    font: 14px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background: #fff;
    outline: none;
  }
  .toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #e1e5ea;
    background: #fff;
    color: #222;
    cursor: pointer;
  }
  .btn:hover { background: #f6f8fb; }
  .btn.primary {
    border-color: rgba(47,128,237,.35);
    color: #0b62d6;
    background: rgba(47,128,237,.08);
  }

  /* DnD visual */
  .tab.drag-over {
    outline: 2px dashed rgba(47,128,237,.6);
    outline-offset: 2px;
  }

  @media (max-width: 600px) {
    .app {
      margin: 10px;
      padding: 5px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .tab {
      padding: 12px;
      font-size: 18px;
    }
    .btn {
      padding: 15px;
      font-size: 18px;
      margin: 5px 0;
    }
    .editor {
      min-height: 150px;
      font-size: 16px;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">ちょいメモ Web</div>
      <div style="margin-left:auto; color:#8b9096; font-size:12px">ダブルクリックでタブ名編集／ドラッグで並び替え</div>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="tabs-footer">
      <button class="btn primary" id="addBtn">＋ 新しいメモ</button>
    </div>

    <div class="editor-wrap">
      <textarea id="editor" class="editor" placeholder="ここにメモを入力..."></textarea>
      <div class="toolbar">
        <button class="btn" id="copyBtn">クリップボードにコピー</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const LS_KEY = 'choi-memo-web';
  let state = load() ?? {
    memos: [{ id: uuid(), title: 'メモ1', content: '', createdAt: Date.now() }],
    selectedIndex: 0
  };

  const tabsEl = document.getElementById('tabs');
  const editorEl = document.getElementById('editor');
  const addBtn   = document.getElementById('addBtn');
  const copyBtn  = document.getElementById('copyBtn');

  let dragSourceIndex = null;

  function uuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
      const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function load() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); }
    catch { return null; }
  }

  function currentMemo() { return state.memos[state.selectedIndex]; }

  function setSelected(index) {
    state.selectedIndex = Math.max(0, Math.min(index, state.memos.length - 1));
    save();
    render();
  }

  function addMemo() {
    const n = state.memos.length + 1;
    state.memos.push({ id: uuid(), title: `メモ${n}`, content: '', createdAt: Date.now() });
    setSelected(state.memos.length - 1);
  }

  function deleteMemo(index) {
    if (state.memos.length <= 1) return;
    state.memos.splice(index, 1);
    if (state.selectedIndex >= state.memos.length) state.selectedIndex = state.memos.length - 1;
    save();
    render();
  }

  function updateTitle(index, newTitle) {
    const t = (newTitle || '').trim();
    if (!t) return;
    state.memos[index].title = t;
    save();
    render();
  }

  function moveMemo(source, destination) {
    if (source === destination) return;
    destination = Math.max(0, Math.min(destination, state.memos.length - 1));
    const m = state.memos.splice(source, 1)[0];
    if (source < destination) destination -= 1;
    state.memos.splice(destination, 0, m);

    if (state.selectedIndex === source) {
      state.selectedIndex = destination;
    } else if (source < state.selectedIndex && state.selectedIndex <= destination) {
      state.selectedIndex -= 1;
    } else if (destination <= state.selectedIndex && state.selectedIndex < source) {
      state.selectedIndex += 1;
    }
    save();
    render();
  }

  // タブの名前変更をタッチで行う
  function enableTabRenameOnTouch(tab, index, memo) {
    tab.addEventListener('touchend', (e) => {
      if (!e.target.classList.contains('icon-btn')) {
        startEditTitle(tab, index, memo.title);
      }
    });
  }

  // タブの入れ替えをスワイプで行う
  function enableTabSwapOnSwipe(tab, index) {
    let startX;
    tab.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    });
    tab.addEventListener('touchmove', (e) => {
      const moveX = e.touches[0].clientX;
      if (startX && Math.abs(moveX - startX) > 50) {
        const direction = moveX > startX ? 'right' : 'left';
        const newIndex = direction === 'right' ? index + 1 : index - 1;
        moveMemo(index, newIndex);
        startX = null;
      }
    });
  }

  // タブのレンダリング時に新しいイベントを追加
  function renderTabs() {
    tabsEl.innerHTML = '';
    state.memos.forEach((memo, index) => {
      const tab = document.createElement('div');
      tab.className = 'tab' + (index === state.selectedIndex ? ' active' : '');
      tab.setAttribute('draggable', 'true');

      const label = document.createElement('span');
      label.className = 'label';
      label.textContent = memo.title;
      label.title = memo.title;

      const del = document.createElement('button');
      del.className = 'icon-btn danger';
      del.innerHTML = '✕';
      del.title = '削除';
      del.onclick = (e) => { e.stopPropagation(); deleteMemo(index); };
      if (state.memos.length <= 1) del.style.visibility = 'hidden';

      tab.appendChild(label);
      tab.appendChild(del);
      tab.onclick = () => setSelected(index);

      enableTabRenameOnTouch(tab, index, memo);
      enableTabSwapOnSwipe(tab, index);

      tabsEl.appendChild(tab);
    });
  }

  function startEditTitle(tab, index, currentTitle) {
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'title-edit';
    input.value = currentTitle;
    input.onblur = () => finishEditTitle(tab, index, input.value);
    input.onkeydown = (e) => {
      if (e.key === 'Enter') {
        finishEditTitle(tab, index, input.value);
      } else if (e.key === 'Escape') {
        renderTabs(); // キャンセルして元に戻す
      }
    };
    tab.replaceChild(input, tab.querySelector('.label'));
    input.focus();
  }

  function finishEditTitle(tab, index, newTitle) {
    updateTitle(index, newTitle);
    renderTabs();
  }

  function renderEditor() {
    const memo = currentMemo();
    editorEl.value = memo?.content ?? '';
  }

  function render() {
    renderTabs();
    renderEditor();
  }

  // events
  editorEl.addEventListener('input', () => {
    editorEl.style.height = 'auto';
    editorEl.style.height = editorEl.scrollHeight + 'px';
  });

  addBtn.addEventListener('click', addMemo);

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(editorEl.value ?? '');
      copyBtn.textContent = 'コピーしました';
      setTimeout(()=> copyBtn.textContent = 'クリップボードにコピー', 1200);
    } catch {
      alert('コピーに失敗しました');
    }
  });

  // Ensure right-click name change works on mobile
  tabsEl.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const tab = e.target.closest('.tab');
    if (!tab) return;
    const index = Array.from(tabsEl.children).indexOf(tab);
    if (index === -1) return;
    const memo = state.memos[index];
    startEditTitle(tab, index, memo.title);
  });

  // init
  render();
});
</script>
</body>
</html>